<!-- based on this code https://glitch.com/edit/#!/stack-57493298 from this stackoverflow question https://stackoverflow.com/questions/57493298/a-frame-with-device-camera-how-to-see-video-behind-the-a-scene and from this qr code tutorial from this online tutorial https://itnext.io/creating-a-real-time-qr-code-scanner-with-vanilla-javascript-part-1-2-creating-the-scanner-a8934ee8f614 -->
<!doctype html>
<html lang="en">
<head>
    <!-- <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script> -->
    <title>Simple Web AR</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.2.0/dist/aframe-environment-component.min.js"></script>
    <style>   
        #webcam {
            opacity:1;
            position: fixed;
            background-size: 100% 100%;
            top: 0; left: 0; 
            min-width: 100%; min-height: 100%;
            width: auto; height: auto;
        }
    </style>
    <script>
      // Define a few custom components useful for AR mode. While these are somewhat reusable,
      // I recommend checking if there are officially supported alternatives before copying
      // these into new projects.

      // See also https://github.com/aframevr/aframe/pull/4356
      AFRAME.registerComponent('hide-in-ar-mode', {
        // Set this object invisible while in AR mode.
        init: function () {
          this.el.sceneEl.addEventListener('enter-vr', (ev) => {
            this.wasVisible = this.el.getAttribute('visible');
            if (this.el.sceneEl.is('ar-mode')) {
              this.el.setAttribute('visible', false);
            }
          });
          this.el.sceneEl.addEventListener('exit-vr', (ev) => {
            if (this.wasVisible) this.el.setAttribute('visible', true);
          });
        }
      });
      
      AFRAME.registerComponent('ar-shadows', {
        // Swap an object's material to a transparent shadows-only material while
        // in AR mode. Intended for use with a ground plane. The object is also
        // set visible while in AR mode, this is useful if it's hidden in other
        // modes due to them using a 3D environment.
        schema: {
          opacity: {default: 0.3}
        },
        init: function () {
          this.el.sceneEl.addEventListener('enter-vr', (ev) => {
            this.wasVisible = this.el.getAttribute('visible');
            if (this.el.sceneEl.is('ar-mode')) {
              this.savedMaterial = this.el.object3D.children[0].material;
              this.el.object3D.children[0].material = new THREE.ShadowMaterial();
              this.el.object3D.children[0].material.opacity = this.data.opacity;
              this.el.setAttribute('visible', true);
            }
          });
          this.el.sceneEl.addEventListener('exit-vr', (ev) => {
            if (this.savedMaterial) {
              this.el.object3D.children[0].material = this.savedMaterial;
              this.savedMaterial = null;
            }
            if (!this.wasVisible) this.el.setAttribute('visible', false);
          });
        }
      });    
    </script>
    
    </head>
    <body>
        <video id="webcam" autoplay playsinline></video>
        <a-scene cursor="rayOrigin: mouse">
        <!-- <a-scene vr-mode-ui="enabled: false"> -->
          <a-camera id="cam" position="0 1.2 0">
            <!-- <a-entity id="refresh-button" geometry="primitive: box" material="color: pink" position="0 -1.2 -2" scale = "0.2 0.2 0.2"></a> -->
    
          </a-camera>
          
          <!-- Environment for 2D and VR viewing. It's auto-hidden in AR mode. -->
          <a-entity environment="preset: forest; lighting: none; shadow: none; lightPosition: 0 2.15 0"
                    hide-in-ar-mode></a-entity>
          
          <!-- this creates a wrapper for the centre of rotation of the object to be at the camera  -->
          <a-entity id="newRotationCentre" position="0 1.2 0">
              <!-- added -1.2 to the postion as the wrapper brings the objects position right to it -->
              <a-box id="dino" position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
    
          </a-entity>
    
          <a-entity light="type: ambient; intensity: 0.5;"></a-entity>
          <a-light type="directional"
                   light="castShadow: true;
                          shadowMapHeight: 1024;
                          shadowMapWidth: 1024;
                          shadowCameraLeft: -7;
                          shadowCameraRight: 5;
                          shadowCameraBottom: -5;
                          shadowCameraTop: 5;"
                   id="light"
                   target="dino"
                   position="-5 3 1.5"></a-light>
            
        </a-scene>
        <script>

        const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
            var cameraView;
            var newElement = false;
    
            var constraints = {
                audio: false,
                video: {
                    facingMode: "environment",
                }
            };

        const video = document.getElementById('webcam');

        let dino = document.getElementById('dino');
        let dinoCameraCentre = document.getElementById('newRotationCentre');
        let mainCamera = document.getElementById('cam');
        // let inVRToggle = document.getElementById('refresh-button');
        let toggleDinoVisiblity = false;
        var newCode = false;
              
        dino.setAttribute('scale', {x: 0.5, y: 0.5, z: 0.5});


        function changeObjectRotation(){
            let rot = mainCamera.getAttribute('rotation');
        }

    
            // Access the device camera and stream to cameraView
            // function cameraStart() {
            //     cameraView = document.querySelector("#webcam");
            //     navigator.mediaDevices
            //         .getUserMedia(constraints)
            //         .then(function(stream) {
            //         cameraView.srcObject = stream;
            //     })
            //     .catch(function(error) {
            //         console.error("Oops. Something is broken.", error);
            //     });
            // }
    
            // Start the video stream when the window loads
            // window.addEventListener("load", cameraStart, false);


            
                // const video = document.getElementById('webcam');
                
                // Check for a camera
                // if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                // const constraints = {
                //     video: true,
                //     audio: false
                // };

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                  const constraints = {
                                audio: false,
                                video: {
                                    facingMode: "environment",
                                }
                    };
                
                // Start video stream
                navigator.mediaDevices.getUserMedia(constraints).then(stream => video.srcObject = stream);
                }


                // const detectCode = () => {
                // barcodeDetector.detect(video).then(codes => {
                //     // If no codes exit function and clear canvas
                //     // if (codes.length === 0) return drawCodePath({});
                //     if (codes.length === 0){
                //         // console.log('no code');
                //         if (newCode === true){
                //             newCode = false;
                //         }
                //         console.log('in code length 0 ' + newCode)
                //         return;
                //     }

                //     if (newCode === false){
                //         console.log('in new code ' + newCode)
                //         newCode = true;
                //         // console.log(codes);
                //         // alert(codes);
                //         for (const barcode of codes)  {
                //             console.log(barcode.rawValue);
                //             console.log(typeof(barcode.rawValue));
                //             if(barcode.rawValue === "https://example.com/"){
                //                 console.log("make a change to the AR");
                //                 if(newElement === false){
                //                     newElement = true;
                //                     var sceneEl = document.querySelector('a-scene');
                //                     var entityEl = document.createElement('a-entity');
                //                     entityEl.setAttribute('geometry', {
                //                     primitive: 'box',
                //                     height: 3,
                //                     width: 1,
                //                     color:"aqua"
                //                     });
                //                     entityEl.setAttribute('position', {x: 7, y: 0, z: 7});
                //                     sceneEl.appendChild(entityEl);
                //                 }
                //             } else {
                //                 console.log('not registering the URL')
                //             }
                //         }
                //     }

                // }).catch(err => {
                //     console.error(err);
                // })
                // }

                // // Run detect code function every 100 milliseconds
                // setInterval(detectCode, 100);

            </script>
    </body>