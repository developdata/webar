<!doctype html>
<html lang="en">
<head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <style>   
        #camera {
            opacity:1;
            position: fixed;
            background-size: 100% 100%;
            top: 0; left: 0; 
            min-width: 100%; min-height: 100%;
            width: auto; height: auto;
        }
    </style>

    
</head>
<body>
    <video id="camera" autoplay playsinline></video>

    <a-scene vr-mode-ui="enabled: false">
        <a-sphere cursor-listener position="-7 0 7" radius="1.25" color="yellowgreen"></a-sphere>
        <a-sphere cursor-listener position="-7 0 -7" radius="1.25" color="green"></a-sphere>
        <a-sphere cursor-listener position="7 0 7" radius="1.25" color="aqua"></a-sphere>
        <a-sphere id="orange" cursor-listener position="7 0 -7" radius="1.25" color="orange"></a-sphere>
        <a-entity camera look-controls></a-entity>
    </a-scene>
    <script>

        let test = document.getElementById('orange');
        alert(test);
        test.addEventListener('click', function () {
            alert('clicked orange sphere');
        }, false );
        
        const video = document.getElementById('camera');
        var newElement = false;
        var newCode = false;

        var constraints = {
            audio: false,
            video: {
                facingMode: "environment",
            }
        };

        function cameraStart() {
            
            navigator.mediaDevices
                .getUserMedia(constraints)
                .then(function(stream) {
                video.srcObject = stream;
            })
            .catch(function(error) {
                console.error("Oops. Something is broken.", error);
            });
        }

        // Start the video stream when the window loads
        window.addEventListener("load", cameraStart, false);

        const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
            
        // Check for a camera
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            // Start video stream
            navigator.mediaDevices.getUserMedia(constraints).then(stream => video.srcObject = stream);
        }
        // Detect code function 
        const detectCode = () => {
        barcodeDetector.detect(video).then(codes => {
            // If no codes exit function and clear canvas
            // if (codes.length === 0) return drawCodePath({});
            if (codes.length === 0){
                // console.log('no code');
                if (newCode === true){
                    newCode = false;
                }
                console.log('in code length 0 ' + newCode)
                return;
            }

            if (newCode === false){
                newCode = true;
                for (const barcode of codes)  {
                    console.log(barcode.rawValue);
                    if(barcode.rawValue === "https://example.com/"){
                        console.log("make a change to the AR");
                        if(newElement === false){
                            newElement = true;
                            var sceneEl = document.querySelector('a-scene');
                            var entityEl = document.createElement('a-entity');
                            entityEl.setAttribute('geometry', {
                            primitive: 'box',
                            height: 3,
                            width: 3,
                            color:'aqua'
                            });
                            entityEl.setAttribute('position', {x: 7, y: 0, z: -7});
                            sceneEl.appendChild(entityEl);
                        }
                    } else {
                        console.log('not registering the URL')
                    }
                }
            }

        }).catch(err => {
            console.error(err);
        })
        }

        // Run detect code function every 100 milliseconds
        setInterval(detectCode, 100);

    </script>
</body>

</html>